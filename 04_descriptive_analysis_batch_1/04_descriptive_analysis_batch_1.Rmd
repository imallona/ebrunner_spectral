---
title: "Erich Brunner's Spectral prototype"
author: "Izaskun Mallona, Mark D. Robinson lab, UZH"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: kable
    theme: lumen
params:
  seed: 665
---

# Aim

```
to do
```

To be run in R 4.1.x with BioC 3.13

# Findings

```
to do
```

# Overview

```{r}
ID <- '04_descriptive_spectral_batch_1'
BASE <- file.path('/home', 'imallona')
WD <- file.path(BASE, 'giulia', ID)
DATA <- file.path(BASE, 'giulia', 'data')
DOWNSAMPLE <- FALSE

## setwd(WD)

NTHREADS <- 10
```

```{r settings, include = TRUE}
suppressPackageStartupMessages({
    ## library(paletteer)
    library(RColorBrewer)
    library(knitr)
    library(Seurat)
    library(scater)
    library(data.table)
    library(SingleCellExperiment)
    library(scran)
    ## library(org.Hs.eg.db)
    library(dplyr)
    library(DT)
    library(pheatmap)
    library(Cairo)
    library(RColorBrewer)
    library(future)
    library(biomaRt)
    library(BiocParallel)
    library(future)
    library(scDblFinder)
    library(scSorter)
    library(intrinsicDimension)
})

opts_chunk$set(fig.width = 5,
               fig.height = 5,
               cache = TRUE,
               include = TRUE,
               dev = "png",
               cache.lazy = FALSE,
               warning = TRUE,
               message = TRUE)

## plan("multiprocess", workers = NTHREADS)
## options(future.globals.maxSize= 1.4e9)

options(bitmapType='cairo')
```

```{r, eval = TRUE}
plan("multiprocess", workers = NTHREADS)
options(future.globals.maxSize= 30e9)
```

```{r functions}
## add alpha
ac <- function(col, alpha=1){
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}
```

# Unfiltered data {.tabset .tabset-fade .tabset-pills}

```{r data_load, message = FALSE, warning = FALSE}
d <- list(mod = readRDS(file.path(DATA,
                                  'combined__20210923.B-o26015_1_4-SPECTRAL_mod.dgecounts.rds')),
          unmod = readRDS(file.path(DATA,
                                    'combined__20210923.B-o26015_1_3-SPECTRAL_unmod.dgecounts.rds')))

d <- lapply(d, function(x) return(x$umicount$inex$all))

rowdata <- list(mod = read.table(
                     file.path(DATA,
                               'combined__20210923.B-o26015_1_4-SPECTRAL_mod.gene_names.txt'),
                     header = TRUE),
                 unmod = read.table(
                     file.path(DATA,
                               'combined__20210923.B-o26015_1_3-SPECTRAL_unmod.gene_names.txt'),
                     header = TRUE))


coldata <- list(mod = data.frame(cell = colnames(d$mod),
                                 mouse_score = NA, human_score = NA),
                unmod = data.frame(cell = colnames(d$unmod),
                                   mouse_score = NA, human_score = NA))

```

```{r harmonize_missing_genes_all_genes}
common <- unique(unlist(lapply(d, function(x) return(dimnames(x)[[1]]))))
for (item in names(d)) {
    missing <- setdiff(common, dimnames(d[[item]])[[1]])

    d[[item]] <- rbind(as.matrix(d[[item]]),
                       matrix(data = 0, ncol = ncol(d[[item]]), nrow = length(missing),
                              dimnames = list(missing, colnames(d[[item]]))))
}
```


```{r harmonize_rowdata}
for (item in names(d)) {
    if (!'egfp' %in% rowdata[[item]]$gene_id) { 
        rowdata[[item]] <- rbind(rowdata[[item]], data.frame(gene_id = c('egfp', 'tdtomato'),
                                                             gene_name = c('egfp', 'tdtomato')))
    }
    
    rownames(rowdata[[item]]) <- rowdata[[item]]$gene_id
    ## head(rownames(rowdata[[item]]))
    ## head(dimnames(d[[item]])[[1]])
    ## setdiff(dimnames(d[[item]])[[1]], rownames(rowdata[[item]]))

    rowdata[[item]] <- rowdata[[item]][dimnames(d[[item]])[[1]],]

    ## table(rownames(rowdata[[item]]) != dimnames(d[[item]])[[1]])
    ## rownames(rowdata[[item]])[rownames(rowdata[[item]]) != dimnames(d[[item]])[[1]]]
    stopifnot(all(rownames(rowdata[[item]]) == dimnames(d[[item]])[[1]]))
}
                
```

```{r harmonize_by_gene_symbol}

## maybe, we could collapse features that belong to the same genesymbol, mainly
##  for the dimred
for (item in names(rowdata)) {
    rowdata[[item]]$gene_name_upper <- toupper(rowdata[[item]]$gene_name)

    tmp <- as.data.frame(table(rowdata[[item]]$gene_name_upper))

    rowdata[[item]]$shared <- NA
    rowdata[[item]][rowdata[[item]]$gene_name_upper %in% tmp[tmp$Freq >= 2,
                                                             'Var1'], 'shared'] <- 'shared'

    
    rowdata[[item]][rowdata[[item]]$gene_name_upper %in% tmp[tmp$Freq == 1, 'Var1'] &
                    grepl('ENSG', rowdata[[item]]$gene_id), 'shared'] <- 'human_only'

    rowdata[[item]][rowdata[[item]]$gene_name_upper %in% tmp[tmp$Freq == 1, 'Var1'] &
                     grepl('ENSMUSG', rowdata[[item]]$gene_id), 'shared'] <- 'mouse_only'

    rowdata[[item]][rowdata[[item]]$gene_id %in% c('tdtomato', 'egfp'), 'shared'] <- 'shared'

    print(table(rowdata[[item]]$shared, useNA = 'always'))

    ## head(rowdata[[item]][is.na(rowdata[[item]]$shared),])    
}

```

```{r slow_fixme}
## collapse reads by gene symbol, and create a reduced dataframe with those
## to do: speed this up, make it more elegant

harm <- list()
for (item in names(d)) {
    shared_symbols <- unique(rowdata[[item]]$gene_name_upper[rowdata[[item]]$shared == 'shared'])

    harm[[item]] <- as.data.frame(matrix(data = 0,
                                         nrow = length(shared_symbols),
                                         ncol = ncol(d[[item]])),
                                  row.names = shared_symbols,
                                  col.names = colnames(d[[item]]))
    colnames(harm[[item]]) <- colnames(d[[item]])

    for (alien in c('tdtomato', 'egfp')) 
        rownames(harm[[item]]) <- gsub(toupper(alien), alien, rownames(harm[[item]]))

    ## test start
    harm[[item]] <- do.call(rbind.data.frame,
                            lapply(rownames(harm[[item]]),
                                   function(x) {
                                       symbol <- x
                                       tmp <- d[[item]][rowdata[[item]][rowdata[[item]]$gene_name_upper == symbol, 'gene_id'],]
               return(colSums(tmp))
                                   }))
               
    colnames(harm[[item]]) <- colnames(d[[item]])
    rownames(harm[[item]]) <- shared_symbols
        
}


##     ## test end
    
##     for (symbol in rownames(harm[[item]])) {       
##         harm[[item]][symbol,] <- colSums(d[[item]][rowdata[[item]][rowdata[[item]]$gene_name_upper == symbol, 'gene_id'],])
##     }
## }
```


- Mouse score: reads mapped to mouse / reads in total
- Human score: reads mapped to human / reads in total

```{r mouse_human_scores}
human_pattern <- 'ENSG'
mouse_pattern <- 'ENSMUSG'
for (item in names(d)) {
    coldata[[item]]$total_human <- colSums(d[[item]][grep(human_pattern, rownames(d[[item]])),])
    coldata[[item]]$total_mouse <- colSums(d[[item]][grep(mouse_pattern, rownames(d[[item]])),])
    coldata[[item]]$total <- colSums(d[[item]])
    coldata[[item]]$total_alien <- coldata[[item]]$total - (coldata[[item]]$total_mouse +
                                                            coldata[[item]]$total_human)
}
```

```{r coloring_cells}
for (item in names(d)) {
    coldata[[item]]$human_score <- coldata[[item]]$total_human / coldata[[item]]$total
    coldata[[item]]$mouse_score <- coldata[[item]]$total_mouse / coldata[[item]]$total
    for (alien in c('tdtomato', 'egfp')) {
        coldata[[item]][,alien] <- d[[item]][alien,]
    }
    coldata[[item]]$color <- 'black'
    coldata[[item]][coldata[[item]]$tdtomato > 0, 'color'] <- 'red'
    coldata[[item]][coldata[[item]]$egfp > 0, 'color'] <- 'forestgreen'
    coldata[[item]][coldata[[item]]$egfp > 0 & coldata[[item]]$tdtomato > 0, 'color'] <- 'blue'
}

```

## Mod pairwise plots

```{r fig.height = 6, fig.width = 6}
## shuffling so plotting is a bit less biased
set.seed(2)
coldata$mod <- coldata$mod[sample(1:nrow(coldata$mod), nrow(coldata$mod), replace = FALSE),]

plot(coldata$mod[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')],
     pch = 20, main = 'mod', cex = 0.5,
     col = coldata$mod$color)
```

## Unmod pairwise plots

```{r fig.height = 6, fig.width = 6}
## shuffling so plotting is a bit less biased
set.seed(542)
coldata$unmod <- coldata$unmod[sample(1:nrow(coldata$unmod), nrow(coldata$unmod),
                                      replace = FALSE),]


plot(coldata$unmod[,c('total_human', 'total_mouse', 'total_alien',
                      'egfp', 'tdtomato')],
     pch = 20, main = 'unmod', cex = 0.5,
     col = coldata$unmod$color)
```

## Human/mouse thresholds

```{r sce_object_combined, eval = FALSE}
for (item in names(d)) {
    coldata[[item]][,'name'] <- item
    colnames(d[[item]]) <- sprintf('%s_%s', item, colnames(d[[item]]))
    coldata[[item]]$cell <- sprintf('%s_%s', item, coldata[[item]]$cell)

    rownames(coldata[[item]]) <- coldata[[item]]$cell
    coldata[[item]] <- coldata[[item]][colnames(d[[item]]),]    
}
```

```{r sce_object_on_shared_genes_only}
for (item in names(harm)) {
    coldata[[item]][,'name'] <- item
    colnames(harm[[item]]) <- sprintf('%s_%s', item, colnames(harm[[item]]))
    coldata[[item]]$cell <- sprintf('%s_%s', item, coldata[[item]]$cell)

    rownames(coldata[[item]]) <- coldata[[item]]$cell
    coldata[[item]] <- coldata[[item]][colnames(harm[[item]]),]    
}

tmp_counts <- cbind(harm[[1]], harm[[2]])
rownames(tmp_counts) <- rownames(harm[[1]])
## tmp_counts[1:5, 1:5]
## rm(d)

tmp_col <- rbind(coldata[[1]], coldata[[2]])
rownames(tmp_col) <- tmp_col$cell
## tmp_counts[1:5,1:5]

stopifnot(all(colnames(tmp_counts) == rownames(tmp_col)))
## stopifnot(all(rownames(tmp_counts) == rownames(rowdata[[1]])))

## to do: better track the gene symbols that were collapsed
sce <- SingleCellExperiment(list(counts = as.matrix(tmp_counts)),
                             colData = tmp_col,
                            rowData = data.frame(gene_name = rownames(tmp_counts)))
rm(tmp_counts, tmp_col, d, harm)
```

```{r}
if (DOWNSAMPLE) {
    sce <- sce[,sample(1:ncol(sce), 1000, replace = FALSE)]
}
```

```{r binarize_species, fig.height = 4, fig.width = 8}
THRES <- 0.7
par(mfrow = c(1,2))
hist(colData(sce)$mouse_score, main = 'mouse scores')
abline(v = THRES, col = 'blue')

hist(colData(sce)$human_score, main = 'human scores')
colData(sce)$species <- 'unknown'
abline(v = THRES, col = 'blue') 

colData(sce)[colData(sce)$mouse_score >= THRES, 'species'] <- 'mouse'
colData(sce)[colData(sce)$human_score >= THRES, 'species'] <- 'human'

```

## Species cross-tabulation


```{r}
table(colData(sce)$species, colData(sce)$name)
```

# QC before filtering

## Per cell and per feature QC {.tabset .tabset-fade .tabset-pills}

```{r qualmetrics, fig.width = 5, fig.height = 4, results = 'asis'}

sce <- sce[,colSums(counts(sce)) > 0]

sce <- sce[rowSums(counts(sce)) > 0,]
## dim(sce)
## sce <- calculateQCMetrics(sce)
## colnames(colData(sce))
mt_regex <- '^MT-'
sce <- addPerCellQC(sce, 
                    subsets = list(mito = grep(mt_regex,
                                               rowData(sce)$gene_name, value = FALSE)))

cat('### ', 'Sum vs detected (by name)', ' \n\n')
plotColData(sce, x = "sum", y="detected", colour_by = c("name"))
cat('\n\n')

cat('### ', 'Sum vs detected (by species)', ' \n\n')
plotColData(sce, x = "sum", y="detected", colour_by = c("species"))
cat('\n\n')

cat('### ', 'Highest expressed', ' \n\n')
plotHighestExprs(sce, exprs_values = "counts")
cat('\n\n')
```


```{r varpart, fig.width = 4, fig.height = 4, results = 'asis'}
sce <- logNormCounts(sce) 
## colData(sce)$name <- colData(sce)$orig.ident
vars <- getVarianceExplained(sce, variables = c("name", "species"))

cat('### ', 'Variance partitioning', ' \n\n')
plotExplanatoryVariables(vars)
cat('\n\n')
```

```{r}
sce <- addPerFeatureQC(sce)

## colnames(colData(sce))

```


## Doublet detection  {.tabset .tabset-fade .tabset-pills}


### Doublets detected

```{r doublet_detection, warnings = FALSE}

colData(sce)$compound_id <- sprintf('%s_%s', colData(sce)$name, colData(sce)$species)

# the expected proportion of doublets is 1% per 1000 cells
sce <- scDblFinder(sce, samples = "name", BPPARAM = MulticoreParam(NTHREADS))

table(colData(sce)[,c("scDblFinder.class", "compound_id")])
```

### Doublets and singlets, by assigned status

Red depicts doublets

```{r, fig.width = 6, fig.height = 6}

plot(as.data.frame(colData(sce)[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')]),
     pch = 20, main = 'scDblFinder doublets', cex = 0.5,
     col = as.numeric(colData(sce)$scDblFinder.class))
```


### Doublets only, by alien

```{r, fig.width = 6, fig.height = 6}

curr <- subset(sce, , scDblFinder.class == 'doublet')

plot(as.data.frame(colData(curr))[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')],
     pch = 20, main = 'scDblFinder doublets', cex = 0.5,
     col = colData(curr)$color)
```

### Doublet scores (for doublets only)

```{r, fig.width = 6, fig.height = 6}

## pal <- paletteer::paletteer_c("viridis::viridis", n = 20)
pal <- brewer.pal(9, "Blues")
# Transform the numeric variable in bins
score_rank <- as.factor(as.numeric(cut(colData(curr)$scDblFinder.score, 9)))


plot(as.data.frame(colData(curr)[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')]),
     pch = 20, main = 'scDblFinder doublets', cex = 0.5,
     col = pal[as.numeric(score_rank)])

```


### Singlets only, by alien

```{r, fig.width = 6, fig.height = 6}

curr <- subset(sce, , scDblFinder.class == 'singlet')

plot(as.data.frame(colData(curr))[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')],
     pch = 20, main = 'scDblFinder singlets', cex = 0.5,
     col = colData(curr)$color)
```


```{r doublet_removal}
sce <- sce[,sce$scDblFinder.class == "singlet"]

```

# Quality metrics and outlier detection  {.tabset .tabset-fade .tabset-pills}

```{r outliers}
libsize.drop <- isOutlier(sce$total, nmads = 2, type = "both", log = TRUE,
                          batch = sce$compound_id)
feature.drop <- isOutlier(sce$detected, nmads = 2, type = "both", log = TRUE,
                          batch = sce$compound_id)
mito.drop <- isOutlier(sce$subsets_mito_percent, nmads = 2, type = "higher",
                       batch = sce$compound_id, log = FALSE)
## mito.drop.manual <- sce$subsets_mito_percent >= 15
libsize.drop.manual <- sce$total < 5000

```


## Cells before QC


```{r}

table(colData(sce)$compound_id, useNA = 'always')
```

## Overall quality metrics before QC (hist) {.tabset .tabset-fade .tabset-pills}


```{r scater_plots_before, results = 'asis'}

for (id in unique(colData(sce)$compound_id)) {
    par(mfrow=c(2,2), mar=c(5.1, 4.1, 0.1, 0.1))

    curr <- subset(sce, , compound_id == id)
    
    cat('### ', id, ' \n\n') 
    hist(curr$total/1e3, xlab="Library sizes (thousands)", main="", 
         breaks=20, col="grey80", ylab="Number of cells")
    abline(v = attr(libsize.drop, 'thresholds')['lower', id]/1e3, col = 'blue')
    abline(v = attr(libsize.drop, 'thresholds')['higher', id]/1e3, col = 'blue')

    hist(curr$detected, xlab="Number of expressed genes", main="", 
         breaks=20, col="grey80", ylab="Number of cells")
    abline(v = attr(feature.drop, 'thresholds')['lower', id], col = 'blue')
    abline(v = attr(feature.drop, 'thresholds')['higher', id], col = 'blue')

    ## hist(curr$altexps_spikes_percent, xlab="ERCC proportion (%)",
    ##      ylab="Number of cells", breaks=20, main="", col="grey80")
    ## abline(v = attr(spike.drop, 'thresholds')['higher', id], col = 'blue')

    hist(curr$subsets_mito_percent, xlab="Mitochondrial proportion (%)", 
         ylab="Number of cells", breaks=20, main="", col="grey80")
    abline(v = attr(mito.drop, 'thresholds')['higher', id], col = 'blue')
    cat('\n\n')
}

```

## Overall quality metrics before QC (scatter) {.tabset .tabset-fade .tabset-pills}

```{r library_sizes_before, , results = 'asis'}
for (id in unique(colData(sce)$compound_id)) {
    par(mfrow=c(2,2), mar=c(5.1, 4.1, 0.1, 0.1))

    curr <- subset(sce, , compound_id == id)
    cat('### ', id, ' \n\n') 
    
    plot(density(curr$total/1e3),
         xlab = "library sizes (thousands)",
         main = '')

    rug(curr$total/1e3)

    plot(y = curr$total/1e3,
         x = curr$subsets_mito_percent,
         col = ac(curr$color, 0.5),
         pch = 20,
         ylab = 'library size (thousands)',
         xlab = 'mitochondrial proportion (%)',
         ## col = ac('black', 0.5)
         )

    plot(y = curr$total/1e3,
         x = curr$detected,
         col = ac(curr$color, 0.5),
         pch = 20,
         ylab = 'library size (thousands)',
         xlab = 'number of genes')
    ## col = ac('black', 0.5)
    ## )

    ## plot(y = curr$total/1e3,
    ##      x = curr$altexps_spikes_percent,
    ##      col = ac(curr$color), 0.5),
    ##      pch = 20,
    ##      ylab = 'library size (thousands)',
    ##      xlab = "ERCC proportion (%)",
    ##      ## col = ac('black', 0.5)
    ##      )

    plot(y = curr$subsets_mito_percent,
         x = curr$detected,
         pch = 20,
         xlab = 'number of genes',
         ylab = 'mitochondrial proportion (%)',
         col = ac('black', 0.5))

    cat('\n\n')
} 
```

## Detected outliers

```{r}
sce <- sce[,!(libsize.drop | feature.drop | mito.drop | libsize.drop.manual)]
data.frame(ByLibSize = sum(libsize.drop | libsize.drop.manual),
           ByFeature = sum(feature.drop), 
           ByMito= sum(mito.drop),
           Remaining = ncol(sce))
```


```{r removal_of_unknowns, cache = FALSE}
sce <- subset(sce, , species %in% c('mouse', 'human'))
```

# QC after filtering {.tabset .tabset-fade .tabset-pills}

## Per cell and per feature QC {.tabset .tabset-fade .tabset-pills}

```{r qualmetricsafter, fig.width = 5, fig.height = 4, results = 'asis'}

cat('### ', 'Sum vs detected (by name)', ' \n\n')
plotColData(sce, x = "sum", y="detected", colour_by = c("name"))
cat('\n\n')

cat('### ', 'Sum vs detected (by species)', ' \n\n')
plotColData(sce, x = "sum", y="detected", colour_by = c("species"))
cat('\n\n')

cat('### ', 'Highest expressed', ' \n\n')
plotHighestExprs(sce, exprs_values = "counts")
cat('\n\n')
```


```{r varpartafter, fig.width = 4, fig.height = 4, results = 'asis'}
vars <- getVarianceExplained(sce, variables = c("name", "species"))

cat('### ', 'Variance partitioning', ' \n\n')
plotExplanatoryVariables(vars)
cat('\n\n')
```


## Overall quality metrics after QC (hists) {.tabset .tabset-fade .tabset-pills}

```{r hists_plots_after, results = 'asis'}

for (id in unique(colData(sce)$compound_id)) {
    par(mfrow=c(2,2), mar=c(5.1, 4.1, 0.1, 0.1))

    curr <- subset(sce, , compound_id == id)
    
    cat('### ', id, ' \n\n') 
    hist(curr$total/1e3, xlab="Library sizes (thousands)", main="", 
         breaks=20, col="grey80", ylab="Number of cells")
    abline(v = attr(libsize.drop, 'thresholds')['lower', id]/1e3, col = 'blue')
    abline(v = attr(libsize.drop, 'thresholds')['higher', id]/1e3, col = 'blue')

    hist(curr$detected, xlab="Number of expressed genes", main="", 
         breaks=20, col="grey80", ylab="Number of cells")
    abline(v = attr(feature.drop, 'thresholds')['lower', id], col = 'blue')
    abline(v = attr(feature.drop, 'thresholds')['higher', id], col = 'blue')

    ## hist(curr$altexps_spikes_percent, xlab="ERCC proportion (%)",
    ##      ylab="Number of cells", breaks=20, main="", col="grey80")
    ## abline(v = attr(spike.drop, 'thresholds')['higher', id], col = 'blue')

    hist(curr$subsets_mito_percent, xlab="Mitochondrial proportion (%)", 
         ylab="Number of cells", breaks=20, main="", col="grey80")
    abline(v = attr(mito.drop, 'thresholds')['higher', id], col = 'blue')
    cat('\n\n')
}

```

## Overall quality metrics after QC (scatter) {.tabset .tabset-fade .tabset-pills}

```{r library_sizes_after, , results = 'asis'}
for (id in unique(colData(sce)$compound_id)) {
    cat('### ', id, ' \n\n') 
    par(mfrow=c(2,2), mar=c(5.1, 4.1, 0.1, 0.1))

    curr <- subset(sce, , compound_id == id)
    
    plot(density(curr$total/1e3),
         xlab = "library sizes (thousands)",
         main = '')

    rug(curr$total/1e3)

    plot(y = curr$total/1e3,
         x = curr$subsets_mito_percent,
         col = ac(curr$color, 0.5),
         pch = 20,
         ylab = 'library size (thousands)',
         xlab = 'mitochondrial proportion (%)',
         ## col = ac('black', 0.5)
         )

    plot(y = curr$total/1e3,
         x = curr$detected,
         col = ac(curr$color, 0.5),
         pch = 20,
         ylab = 'library size (thousands)',
         xlab = 'number of genes')
    ## col = ac('black', 0.5)
    ## )

    ## plot(y = curr$total/1e3,
    ##      x = curr$altexps_spikes_percent,
    ##      col = ac(as.numeric(as.factor(curr$name)), 0.5),
    ##      pch = 20,
    ##      ylab = 'library size (thousands)',
    ##      xlab = "ERCC proportion (%)",
    ##      ## col = ac('black', 0.5)
    ##      )

    plot(y = curr$subsets_mito_percent,
         x = curr$detected,
         pch = 20,
         xlab = 'number of genes',
         ylab = 'mitochondrial proportion (%)',
         col = ac('black', 0.5))

    cat('\n\n')
} 
```


# Dimensions of the filtered dataset

```{r, fig.height = 6, fig.width = 6}
## table(colData(sce)$name, colData(sce)$compound_id, useNA = 'always')

plot(as.data.frame(colData(sce)[,c('total_human', 'total_mouse', 'total_alien',
                    'egfp', 'tdtomato')]),
     pch = 20, main = 'singlets, QC-filtered', cex = 0.5,
     col = colData(sce)$color)

```

```{r}
table(colData(sce)$name, colData(sce)$species, useNA = 'always')

```

Mind that filtering included: removing outlier cells but also the `unknown` cells (with intermediate human/mouse scores).

# Dimred, unsupervised clustering

## Not integrated  {.tabset .tabset-fade .tabset-pills}

```{r}
plan("multiprocess", workers = NTHREADS)
options(future.globals.maxSize= 12.0e9)

```

```{r, warning = FALSE, message =  FALSE}
so <- CreateSeuratObject(counts = counts(sce),
                         project = "brunner_spectral_batch1",
                         meta.data = as.data.frame(colData(sce)),
                         min.cells = 0, min.features = 0,
                         assay = 'RNA')

so <- SCTransform(so,  verbose = FALSE, assay = 'RNA')

```


```{r, message = FALSE, warning = FALSE}

so <- RunPCA(object = so,
             features = VariableFeatures(so),
             verbose = FALSE,
             npcs = 40)

```

### Loadings

```{r, fig.width = 6, fig.height = 8}
VizDimLoadings(object = so, dims = 1:4)
```

### Elbow

```{r, fig.width =4, fig.height = 4}
print(ElbowPlot(object = so, ndims = 40))

```

```{r}
merged_dims <- 1:30
```

```{r, message = FALSE}

so <- FindNeighbors(object = so, dims = merged_dims)

## (resolutions <- seq(0.2, 1.4, by = 0.6))
resolutions <- 0.1

for (res in resolutions) {
    so <- FindClusters(object = so, resolution = res)
}

```

### PCA {.tabset .tabset-fade .tabset-pills}

```{r, fig.width = 7, fig.height = 4, results='asis'}

layers <- c("name", "species",
            grep('snn_res', colnames(so@meta.data), value = TRUE))

for (item in layers){

    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "pca", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))

    cat('\n\n')
}

cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'nFeature_SCT')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'subsets_mito_percent')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

### tSNEs {.tabset .tabset-fade .tabset-pills}

```{r, fig.width = 8, fig.height = 4}

so <- RunTSNE(object = so, dims.use = merged_dims,
              check_duplicates = FALSE,
              do.fast = TRUE, seed.use = 111)
```

```{r, fig.width = 7, fig.height = 4, results='asis'}

for (item in layers){               

    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "tsne", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))
    cat('\n\n')
}
    
cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'nFeature_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'subsets_mito_percent') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

### UMAP {.tabset .tabset-fade .tabset-pills}

```{r, fig.width = 8, fig.height = 4, message = FALSE}
so <- RunUMAP(object = so, reduction = "pca", 
              dims = merged_dims)
```


```{r, fig.width = 7, fig.height = 4, results='asis'}

for (item in layers){
    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "umap", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))
    cat('\n\n')
}

cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'nFeature_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'subsets_mito_percent') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

## Integrated {.tabset .tabset-fade .tabset-pills}

```{r integration, warning = FALSE, message = FALSE}

sol <- SplitObject(so, split.by = "name")
rm(so)


for (i in 1:length(sol)) {
    sol[[i]] <- SCTransform(sol[[i]], verbose = FALSE, assay = 'RNA')
}

features <- SelectIntegrationFeatures(object.list = sol, nfeatures = 2000)
sol <- PrepSCTIntegration(object.list = sol, anchor.features = features, 
                          verbose = FALSE)

anchors <- FindIntegrationAnchors(object.list = sol, normalization.method = "SCT", 
                                  anchor.features = features,
                                  k.anchor = 5,
                                  k.filter = 100,
                                  verbose = FALSE)

so <- IntegrateData(anchorset = anchors, normalization.method = "SCT", 
                    verbose = FALSE)

rm(sol)

```

### Loadings 

```{r seuratsplit, message = FALSE, warning = FALSE}

so <- RunPCA(object = so,
             features = VariableFeatures(so),
             verbose = FALSE,
             npcs = 40)

```

```{r, fig.width = 6, fig.height = 8}
VizDimLoadings(object = so, dims = 1:4)
```

### Elbow

```{r, fig.width =4, fig.height = 4}
print(ElbowPlot(object = so, ndims = 40))

```

```{r}
integrated_dims <- 1:30
```

```{r cluster2, message = FALSE}

so <- FindNeighbors(object = so, dims = integrated_dims )

## (resolutions <- seq(0.2, 1.4, by = 0.6))
resolutions <- 0.1

for (res in resolutions) {
    so <- FindClusters(object = so, resolution = res)
}

```

### PCA {.tabset .tabset-fade .tabset-pills}

```{r pcaplot, fig.width = 7, fig.height = 4, results='asis'}

layers <- c("name", "species",
            grep('snn_res', colnames(so@meta.data), value = TRUE))

for (item in layers){

    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "pca", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))

    cat('\n\n')
}

cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'nFeature_SCT')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'subsets_mito_percent')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "pca", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

### tSNEs {.tabset .tabset-fade .tabset-pills}

```{r tsne, fig.width = 8, fig.height = 4}

so <- RunTSNE(object = so, dims.use = integrated_dims,
              check_duplicates = FALSE,
              do.fast = TRUE, seed.use = 14411)
```

```{r tsneplot, fig.width = 7, fig.height = 4, results='asis'}

for (item in layers){               

    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "tsne", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))
    cat('\n\n')
}
    
cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'nFeature_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'subsets_mito_percent') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "tsne", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

### UMAP {.tabset .tabset-fade .tabset-pills}

```{r umap, fig.width = 8, fig.height = 4, message = FALSE}
so <- RunUMAP(object = so, reduction = "pca", 
              dims = integrated_dims )
```


```{r umapplot, fig.width = 7, fig.height = 4, results='asis'}

for (item in layers){
    cat('#### ', item, ' \n\n')
    print(DimPlot(object = so, reduction = "umap", group.by = item) +
          ggtitle(item) +
          theme(legend.position="right", aspect.ratio = 1))
    cat('\n\n')
}

cat('#### RNA counts \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'nCount_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Number of features \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'nFeature_SCT') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### Percent mitochondrial reads \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'subsets_mito_percent') +
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### egfp \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'egfp')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')

cat('#### tdtomato \n\n')
FeaturePlot(object = so, reduction = "umap", features = 'tdtomato')+
    theme(legend.position="right", aspect.ratio = 1)
cat('\n\n')
```

# Export

```{r}
saveRDS(file = sprintf('%s_sce.rds', ID), object = sce)
```

# Timestamp

```{r sessionInfo2, cache = FALSE}
date()
sessionInfo()
devtools::session_info()
system('uname -a')
system('whoami')
```
